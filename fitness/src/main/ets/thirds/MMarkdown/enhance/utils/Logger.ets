// HiLogUtil.ets
import hilog from '@ohos.hilog';

// import BuildProfile from 'BuildProfile';

// import AppConfig from '../../../../../appCommon/BuildProfile';

/**
 * æ—¥å¿—çº§åˆ«æšä¸¾
 */
export enum LogLevel {
  DEBUG = hilog.LogLevel.DEBUG,
  INFO = hilog.LogLevel.INFO,
  WARN = hilog.LogLevel.WARN,
  ERROR = hilog.LogLevel.ERROR,
  FATAL = hilog.LogLevel.FATAL,
}

/**
 * HiLogå·¥å…·ç±» - æ”¯æŒé•¿æ—¥å¿—æ¢è¡Œã€å¤šçº§åˆ«æ—¥å¿—å’Œå¼ºåˆ¶æ‰“å°
 */
export class LogUtil {
  // æ—¥å¿—æœ€å¤§é•¿åº¦
  private static MAX_LOG_LENGTH: number = 800;
  // å¼ºåˆ¶æ‰“å°æ ‡å¿— - ç”¨äºreleaseç¯å¢ƒ
  private isForcePrint: boolean | undefined = AppStorage.get<boolean>("MarkdownForcePrint");

  // private isForcePrint: boolean = true;

  /**
   * æ‰“å°DEBUGçº§åˆ«æ—¥å¿— - æ”¯æŒå¤šå‚æ•°
   * @param tag æ—¥å¿—æ ‡ç­¾
   * @param messages æ—¥å¿—å†…å®¹å‚æ•°åˆ—è¡¨   */
  public debug(tag: string, ...messages: ESObject[]): void {
    this.printLog(LogLevel.DEBUG, tag, messages);
  }

  /**
   * æ‰“å°INFOçº§åˆ«æ—¥å¿— - æ”¯æŒå¤šå‚æ•°
   * @param tag æ—¥å¿—æ ‡ç­¾
   * @param messages æ—¥å¿—å†…å®¹å‚æ•°åˆ—è¡¨
   */
  public info(tag: string, ...messages: ESObject[]): void {
    this.printLog(LogLevel.INFO, tag, messages);
  }

  /**
   * æ‰“å°WARNçº§åˆ«æ—¥å¿— - æ”¯æŒå¤šå‚æ•°
   * @param tag æ—¥å¿—æ ‡ç­¾
   * @param messages æ—¥å¿—å†…å®¹å‚æ•°åˆ—è¡¨
   */
  public warn(tag: string, ...messages: ESObject[]): void {
    this.printLog(LogLevel.WARN, tag, messages);
  }

  /**
   * æ‰“å°ERRORçº§åˆ«æ—¥å¿— - æ”¯æŒå¤šå‚æ•°
   * @param tag æ—¥å¿—æ ‡ç­¾
   * @param messages æ—¥å¿—å†…å®¹å‚æ•°åˆ—è¡¨
   */
  public error(tag: string, ...messages: ESObject[]): void {
    this.printLog(LogLevel.ERROR, tag, messages, true);
  }

  /**
   * æ‰“å°FATALçº§åˆ«æ—¥å¿— - æ”¯æŒå¤šå‚æ•°
   * @param tag æ—¥å¿—æ ‡ç­¾
   * @param messages æ—¥å¿—å†…å®¹å‚æ•°åˆ—è¡¨
   */
  public fatal(tag: string, ...messages: ESObject[]): void {
    this.printLog(LogLevel.FATAL, tag, messages);
  }

  /**
   * å¼ºåˆ¶æ‰“å°æ—¥å¿—ï¼ˆæ— è§†releaseç¯å¢ƒé™åˆ¶ï¼‰- æ”¯æŒå¤šå‚æ•°
   * @param tag æ—¥å¿—æ ‡ç­¾
   * @param messages æ—¥å¿—å†…å®¹å‚æ•°åˆ—è¡¨
   */
  public infoForce(tag: string, ...messages: ESObject[]): void {
    this.printLog(LogLevel.INFO, tag, messages, true);
  }

  /**
   * å¼ºåˆ¶æ‰“å°æ—¥å¿—ï¼ˆæ— è§†releaseç¯å¢ƒé™åˆ¶ï¼‰- æ”¯æŒå¤šå‚æ•°
   * @param tag æ—¥å¿—æ ‡ç­¾
   * @param messages æ—¥å¿—å†…å®¹å‚æ•°åˆ—è¡¨
   */
  public errorForce(tag: string, ...messages: ESObject[]): void {
    this.printLog(LogLevel.ERROR, tag, messages, true);
  }

  /**
   * æ ¸å¿ƒæ—¥å¿—æ‰“å°æ–¹æ³•
   * @param level æ—¥å¿—çº§åˆ«
   * @param tag æ—¥å¿—æ ‡ç­¾
   * @param messages æ—¥å¿—å†…å®¹å‚æ•°åˆ—è¡¨
   * @param force æ˜¯å¦å¼ºåˆ¶æ‰“å°
   */
  private printLog(
    level: LogLevel,
    tag: string,
    messages: ESObject[],
    force: boolean = false
  ): void {
    // æ£€æŸ¥æ˜¯å¦éœ€è¦æ‰“å°æ—¥å¿—ï¼ˆreleaseç¯å¢ƒä¸‹å¼ºåˆ¶æ‰“å°ï¼‰
    if (!force && !this.isForcePrint) {
      return;
    }

    // å°†å¤šä¸ªå‚æ•°è½¬æ¢ä¸ºæ ¼å¼åŒ–å­—ç¬¦ä¸²
    const message = this.formatMessages(messages);

    // å¤„ç†é•¿æ—¥å¿—æ¢è¡Œ
    if (message.length <= LogUtil.MAX_LOG_LENGTH) {
      this.printSingleLog(level, tag, `${tag} ğŸ‘‰ ${message}`);
      return;
    }

    // åˆ†å‰²é•¿æ—¥å¿—å¹¶é€æ®µæ‰“å°
    let start = 0;
    while (start < message.length) {
      const end = Math.min(start + LogUtil.MAX_LOG_LENGTH, message.length);
      const subMessage = message.substring(start, end);
      this.printSingleLog(level, tag,
        start === 0 ? `${tag} ğŸ‘‰ ${subMessage}` : `    ${subMessage}`
      );
      start = end;
    }
  }

  /**
   * å°†å¤šä¸ªå‚æ•°æ ¼å¼åŒ–ä¸ºå•ä¸ªæ—¥å¿—å­—ç¬¦ä¸²
   * @param messages å‚æ•°åˆ—è¡¨
   */
  private formatMessages(messages: ESObject[]): string {
    return messages.map((item: ESObject) => {
      if (typeof item === 'string' || typeof item === 'number' || typeof item === 'boolean') {
        return item.toString();
      } else if (item instanceof Error) {
        return `${item.name}: ${item.message}\n${item.stack || ''}`;
      } else {
        try {
          return JSON.stringify(item);
        } catch (e) {
          return '[Object]';
        }
      }
    }).join(' ');
  }

  /**
   * æ‰“å°å•æ¡æ—¥å¿—
   * @param level æ—¥å¿—çº§åˆ«
   * @param tag æ—¥å¿—æ ‡ç­¾
   * @param message æ—¥å¿—å†…å®¹
   */
  private printSingleLog(level: LogLevel, tag: string, message: string): void {
    // è·å–è°ƒç”¨è€…ä¿¡æ¯ - å¢å¼ºæ—¥å¿—å¯è¯»æ€§
    const callerInfo = this.getCallerInfo();
    const fullTag = `lv-markdown-in ${callerInfo ? `(${callerInfo})` : ''}`;

    // ä½¿ç”¨hilog
    switch (level) {
      case LogLevel.INFO: // info
        hilog.info(0x0000, fullTag, `${message}`)
        break
      case LogLevel.WARN: // WARN
        hilog.warn(0x0000, fullTag, `${message}`)
        break
      case LogLevel.DEBUG: // DEBUG
        hilog.debug(0x0000, fullTag, `${message}`)
        break
      case LogLevel.ERROR: // ERROR
        hilog.error(0x0000, fullTag, `${message}`)
        break
      case LogLevel.FATAL: // FATAL
        hilog.fatal(0x0000, fullTag, `${message}`)
        break
    }
  }

  /**
   * è·å–è°ƒç”¨è€…ä¿¡æ¯
   * @returns è°ƒç”¨è€…ç±»åå’Œæ–¹æ³•å
   */
  private getCallerInfo(): string | null {
    try {
      // é€šè¿‡é”™è¯¯å †æ ˆè·å–è°ƒç”¨è€…ä¿¡æ¯
      const error = new Error();
      const stack = error.stack || '';

      // è§£æå †æ ˆä¿¡æ¯ï¼Œæ‰¾åˆ°è°ƒç”¨è€…
      const stackLines = stack.split('\n');
      for (let i = 2; i < stackLines.length; i++) {
        const line = stackLines[i].trim();
        if (line.startsWith('at ')) {
          // æå–ç±»åå’Œæ–¹æ³•å
          const match = line.match(/at\s+(.+?)\s*\(/);
          if (match && match[1]) {
            const parts = match[1].split('.');
            if (parts.length > 1) {
              const className = parts[parts.length - 2];
              const methodName = parts[parts.length - 1];
              return `${className}.${methodName}`;
            }
          }
        }
      }
    } catch (e) {
      // å¿½ç•¥è·å–è°ƒç”¨è€…ä¿¡æ¯æ—¶çš„å¼‚å¸¸
    }
    return null;
  }

  public setDebugState(debug: boolean) {
    this.isForcePrint = debug
  }
}

export const Logger = new LogUtil()